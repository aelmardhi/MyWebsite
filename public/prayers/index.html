<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Islamic Prayers Time</title>
    <script src="./main.js"></script>
    <!-- <script src="./degHelpers.js"></script>
    <script src="./prayers.js"></script>
    <script src="./qibla.js"></script> -->
</head>
<style>
:root{
    --clr-primary:#e1ecfc;
    --clr-secondary: #39f;
    --clr-accent1: #06e;
    --clr-accent2: #5af;
    --clr-accent3: #06299c;
    --clr-accent4: #3af;
    --clr-light: #fff;
    --clr-body : #fff;
    --clr-danger: #cf1b24;
    --clr-success: #37fb34;
    --clr-main: none;
    --border1 :  2px solid #39f9;
    --bs-main: none;
    --bs-article: 2px 2px 10px #0003, 10px 10px 20px  #39f5;
    --bs-downloads: inset 0 0 8px #0003 , inset 0 0 15px #0001;
    --bs-downloads-hover: 0 0 6px #0005, 0 0 12px #0003;
    --bs-games:inset 0 0 8px #0005 , inset 0 0 15px #0003;
}
@media(prefers-color-scheme: dark){ 
    :root{   
    --clr-primary:#232834;
    --clr-secondary: #126;
    --clr-accent1: #025;
    --clr-accent2: #128;
    --clr-accent3: #92b3ff;
    --clr-accent4: #126;
    --clr-light: #fff;
    --clr-body : #161009;
    --clr-main: #111320;
    --clr-danger: #8f0a10;
    --clr-success: #1a9c36;
    --border1 :  none;
    --bs-main: inset 0 0 15px #5693, 0 0 10px #5696;
    --bs-article: none;
    --bs-downloads: inset 0 0 8px #0003 , inset 0 0 15px #0001;
    --bs-downloads-hover: 0 0 6px #0005, 0 0 12px #000#37fb343;
    --bs-games:inset 0 0 8px #0005 , inset 0 0 15px #0003;
    }
}
*, *:after, *:before{
    margin: 0;
    padding: 0;
    box-sizing: border-box;
}
body{
    width: 100vw;
    min-height: 100vh;
    justify-content: space-around;
    display: flex;
    flex-direction: column;
    background-color: var(--clr-body);
    overflow-x: hidden;
    font-family: system-ui ,sans-serif;
    color: var(--clr-accent3);
    background: repeating-linear-gradient(45deg ,#0005 0em, #000 5em, #0000 5em, #0000 8em, #003 8em, #0035 13em, #0000 13em, #0000 16em),repeating-linear-gradient(139deg ,#100 0em, #1005 5em, #0000 5em, #0000 8em, #003 8em, #0035 13em, #0000 13em, #0000 16em), linear-gradient(180deg, var(--clr-accent2) 1.25em, var(--clr-body));
}
main{
    margin: 2em auto;
    max-width: 800px;
    width: 100%;
    background-color: var(--clr-primary);
    box-shadow: var(--bs-article);
    display: flex;
    flex-direction: row;
    border-radius: 1em;
    overflow: hidden;
    flex-wrap: wrap;
}
h1{
    color: var(--clr-light);
    padding: .5em 2em;
    font-size: 2em;
    text-align: center;
    background: linear-gradient(90deg,var(--clr-accent1) 20%, var(--clr-accent2) 70%, var(--clr-secondary) 100%);;
}
table{
    border: none;
    width: 100%;
    border-collapse: collapse;
}
tr{
    
    background:linear-gradient(90deg,var(--clr-accent2) , var(--clr-primary) );

}
tr:nth-child(even){
    background:linear-gradient(90deg,var(--clr-primary) , var(--clr-accent2) );
}
button{
    font-weight: bold;
    font-size: large;
    padding: .5em 3em;
    margin: .5em;
}
td{
    text-align: center;
    font-size: 2em;
    padding: .8em .2em; 
}
.column{
    display: flex;
    flex-direction: column;
}
.row{
    display: flex;
    flex-direction: row;
}
.spaceAround{
    justify-content: space-around;
}
.success{
    background-color: var(--clr-success) !important;
}
#location{
    display: none;
    width: 100%;
    flex-direction: column;
    justify-content: center;
    align-items: stretch;
    padding: .25em;
}
.controls{  
    display: flex;
    flex-direction: column;
    justify-content: center;
    align-items: center;
    width: 100%;
}
.controls fieldset{
    display: flex;
    flex-direction: row;
    border: none;
}
.controls fieldset input{
    flex-grow: 2;
    margin: .25em 1em;
    padding: .25em 1em;
}
.info{
    width: 100%;
    text-align: center;
    font-weight: bold;
    font-size: large;
    padding: .5em;
    background-color: var(--clr-accent3);
    color: var(--clr-light);
    border: 2px dashed var(--clr-primary);
}
.changeLocation{
    background-color: var(--clr-accent2);
    color: var(--clr-light);
    border: none;
    box-shadow: var(--bs-article);
}
.changeLocation:hover{
    background-color: var(--clr-accent1);
}
.changeLocation:active{
    box-shadow: var(--bs-main);
}
.qiblaCompass{
    height: 8em;
    width: 8em;
    border-radius: 50%;
    background-color: var(--clr-accent1);
    border: 4px solid var(--clr-accent4);
    position: relative;
    margin: 2em auto;
}
.qibla{
 width: 50%;
}
.qibla div{
    align-items: center;
}
.qibla h2{
    font-size: 4em;
    padding-bottom: .25em;
}
.qibla button{
    font-size: 1em;
    padding: 1em 2em;
    border-radius: 2em;
    background-color: var(--clr-accent3);
    color: var(--clr-body);
    border: 1px solid var(--clr-accent1);
    width: max-content;
}
.qiblaCompass > div{
    width: .5em;
    height: 50%;
    background-color: var(--clr-accent3);
    position: absolute;
    top: 0%;
    left: calc(50% - 0.25em);
    transform-origin: bottom;
}
.prayers{
    width: 50%;
}
@media screen and (max-width:800px){
    body{
        font-size: .75em;
        background: var(--clr-body);
    }
    main{
        margin: 0;
        border-radius: 0;
    }
    .qibla, .prayers{
        width: 100%;
    }
    h1{
        font-size: 3em;
        padding: .5em .5em;
    }
}
</style>
<body>
    <main class="">
        <div class="prayers column">
            <h1>Prayers Times</h1>
            <table id="prayers">
                <tbody></tbody>
            </table>
        </div>
        <div class="qibla column ">
            <h1>Qibla</h1>
            <div class="qiblaCompass">
                <div></div>
            </div>
            <div class="column ">
                <h3>Qibla</h3>
                <h2 id="qiblaValue"></h2>
                <button onclick="setNorth()">Set North</button>
            </div>
        </div>
        <div class="controls">
            <div class="info" id="info"> default location is Khartoum North</div>
            <div id="location">
                <fieldset>
                    <label for="Lng">Longitude</label>
                    <input type="number" id="Lng">
                </fieldset>
                <fieldset>
                    <label for="Lat">Latitude</label>
                    <input type="number" id="Lat">
                </fieldset>
                <button onclick="onAutoDetect()">Auto Detect Location</button>
                <button onclick="saveSettings()">Save Settings </button>
            </div>
            <!-- <a id="setAlarm">Set Alarm</a> -->
            <button class="changeLocation" onclick="changeLocation()">Change Location</button>
        </div>
    </main>
    <script>
        const setAlarmLink = document.getElementById('setAlarm')
        const list = document.querySelector('#prayers tbody')
        const locationElement = document.getElementById('location')
        let changeLocationVisible = false
        let qiblaAngle = 0;
        let screenNorthOrientation = 0;
        let longitude, latitude;
        const LNG_KEY ="prayers__longitude";
        const LAT_KEY = "prayers__latitude";
        function changeLocation(){
            if(!changeLocationVisible){
                changeLocationVisible = true
                locationElement.style.display = 'flex' 
                return
            }
            const lat = parseFloat( document.getElementById('Lat').value)
            const lng = parseFloat( document.getElementById('Lng').value)
            setAll(lng, lat)
            printInfo(`for the location- Longitude: ${lng} and Lat: ${lat} `)
        }
        
        function onAutoDetect(){
            navigator.geolocation.getCurrentPosition((r)=>{
               
                const {latitude: lat, longitude:lng} = r.coords
                setAll(lng, lat)
                printInfo(`for the location detected- Longitude: ${lng} and Lat: ${lat} `)
            } )
        }
        function setNorth(e){
            const options = { frequency: 60, referenceFrame: 'device' };
            const sensor = new RelativeOrientationSensor(options);

            sensor.addEventListener('reading', () => {
            // model is a Three.js object instantiated elsewhere.
            let angle = ToEulerAngles(sensor.quaternion).yaw;
            angle += qiblaAngle;
            angle = Math.round(angle)
            console.log(angle)
            document.querySelector('.qiblaCompass > div').style.transform = 'rotate('+angle +'deg)'
            if((angle%90)==0)
                document.querySelector('.qiblaCompass').classList.add('success')
            else
                document.querySelector('.qiblaCompass').classList.remove('success')
            });
            sensor.addEventListener('error', error => {
            if (event.error.name == 'NotReadableError') {
                console.log("Sensor is not available.");
            }
            });
            Promise.all([navigator.permissions.query({ name: "accelerometer" }),
                        navigator.permissions.query({ name: "gyroscope" })])
                .then(results => {
                    if (results.every(result => result.state === "granted")) {
                    sensor.start();
                    // …
                    } else {
                    console.log("No permissions to use AbsoluteOrientationSensor.");
                    }
            });
        }
        function printInfo(s){
            document.getElementById('info').innerText = s
        }
        function setAlarm(t){
            const intent = `
            intent: +9
            #Intent;   
                action=ACTION_DIAL;  
            end;
            `
            setAlarmLink.href = intent.replaceAll(' ','')
        }
        function setTime(){
            let times
            if(arguments.length)
                times = prayerTimes(...arguments)
            else 
                times = prayerTimes()
            
            list.innerHTML = `
            <tr><td>Fajr </td><td>${times.Fajr}</td></tr>
            <tr><td>Sunrise </td><td>${times.Sunrise}</td></tr>
            <tr><td>Dhuhr </td><td>${times.Dhuhr}</td></tr>
            <tr><td>Asr </td><td>${times.Asr}</td></tr>
            <tr><td>Maghrib </td><td>${times.Maghrib}</td></tr>
            <tr><td>Isha </td><td>${times.Isha}</td></tr>
            `;
            // setAlarm(times.Fajr)
        }
        function setQibla(){
            let angle
            if(arguments.length)
                angle = getQibla(...arguments)
            else 
            angle = getQibla()
            qiblaAngle = angle;
            angle = angle.toFixed(2);
            document.getElementById('qiblaValue').innerText = angle+' °';
            document.querySelector('.qiblaCompass > div').style.transform = 'rotate('+angle +'deg)'
        }
        
        function saveSettings(){
            if(longitude){
                localStorage.setItem(LNG_KEY, longitude);
            }
            if(latitude){
                localStorage.setItem(LAT_KEY, latitude);
            }
        }
        
        function setAll(lng , lat){
            if(lng){
                longitude = lng;
            }else {
                if(localStorage.getItem(LNG_KEY)){
                  lng = localStorage.getItem(LNG_KEY);  
                }
            }
            if(lat){
                latitude = lat;
            }else {
                if(localStorage.getItem(LAT_KEY)){
                  lat = localStorage.getItem(LAT_KEY);  
                }
            }
            if(arguments.length)
                arguments.TimeZone = (new Date().getTimezoneOffset())/-60
            setQibla(...arguments,)
            setTime(...arguments,)
        }
        setAll()
    </script>
</body>
    </html>
